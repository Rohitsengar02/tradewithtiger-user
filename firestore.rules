rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // User Profiles
    // Keep this secure: Users can only read/write their OWN profile.
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
      
      // Saved Posts Subcollection
      match /saved_posts/{postId} {
         allow read, write: if request.auth != null && request.auth.uid == userId;
      }
    }
    
    // Community Features
    match /community/{postId} {
      // Any one can read posts
      allow read: if true;
      
      // Only authenticated users can create posts, and userId must match
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      
      // Updates: 
      // 1. Author can update content
      // 2. Any auth user can update 'likes' (for liking) or 'solutionsCount'
      allow update: if request.auth != null && (
        resource.data.userId == request.auth.uid || 
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['likes', 'solutionsCount', 'isSaved'])
      );
      
      // Only author can delete
      allow delete: if request.auth != null && resource.data.userId == request.auth.uid;

      // Answers Subcollection
      match /answers/{answerId} {
        allow read: if true;
        allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
        allow update, delete: if request.auth != null && resource.data.userId == request.auth.uid;
      }
    }

    // Courses (Admin/Dev Mode - Public R/W as requested)
    match /courses/{courseId} {
      allow read, write: if true;
      
      match /lessons/{lessonId} {
        allow read, write: if true;
      }
      
      match /qa/{questionId} {
        allow read, write: if true;
        match /answers/{answerId} {
           allow read, write: if true;
        }
      }
    }
    
    // Media Library
    match /media/{mediaId} {
      allow read, write: if true;
    }
    
    // Application Settings
    match /settings/{settingId} {
      allow read, write: if true;
    }
    
    // Default deny all other access
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
